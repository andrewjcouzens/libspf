<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libspf v1.0: spfquery.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>spfquery.c</h1><a href="spfquery_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/* libspf - Sender Policy Framework library</span>
00002 <span class="comment">*</span>
00003 <span class="comment">*  ANSI C implementation of spf-draft-200405.txt</span>
00004 <span class="comment">*</span>
00005 <span class="comment">*  Author: James Couzens &lt;jcouzens@codeshare.ca&gt;</span>
00006 <span class="comment">*</span>
00007 <span class="comment">*  File:   spfquery.c</span>
00008 <span class="comment">*  Desc:   SPF Query Tool (an example implementation of libSPF)</span>
00009 <span class="comment">*</span>
00010 <span class="comment">*  License:</span>
00011 <span class="comment">*</span>
00012 <span class="comment">*  The libspf Software License, Version 1.0</span>
00013 <span class="comment">*</span>
00014 <span class="comment">*  Copyright (c) 2004 James Couzens &amp; Sean Comeau  All rights</span>
00015 <span class="comment">*  reserved.</span>
00016 <span class="comment">*</span>
00017 <span class="comment">*  Redistribution and use in source and binary forms, with or without</span>
00018 <span class="comment">*  modification, are permitted provided that the following conditions</span>
00019 <span class="comment">*  are met:</span>
00020 <span class="comment">*</span>
00021 <span class="comment">*  1. Redistributions of source code must retain the above copyright</span>
00022 <span class="comment">*     notice, this list of conditions and the following disclaimer.</span>
00023 <span class="comment">*</span>
00024 <span class="comment">*  2. Redistributions in binary form must reproduce the above copyright</span>
00025 <span class="comment">*     notice, this list of conditions and the following disclaimer in</span>
00026 <span class="comment">*     the documentation and/or other materials provided with the</span>
00027 <span class="comment">*     distribution.</span>
00028 <span class="comment">*</span>
00029 <span class="comment">*  THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED</span>
00030 <span class="comment">*  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
00031 <span class="comment">*  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
00032 <span class="comment">*  DISCLAIMED.  IN NO EVENT SHALL THE AUTHORS MAKING USE OF THIS LICESEN</span>
00033 <span class="comment">*  OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
00034 <span class="comment">*  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
00035 <span class="comment">*  LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF</span>
00036 <span class="comment">*  USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
00037 <span class="comment">*  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
00038 <span class="comment">*  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT</span>
00039 <span class="comment">*  OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00040 <span class="comment">*  SUCH DAMAGE.</span>
00041 <span class="comment">*</span>
00042 <span class="comment">*/</span>
00043 
00044 <span class="preprocessor">#include "<a class="code" href="spfquery_8h.html">spfquery.h</a>"</span>
00045 
00046 
00047 <span class="comment">/* SPF_usage</span>
00048 <span class="comment">*</span>
00049 <span class="comment">*  Author: James Couzens &lt;jcouzens@6o4.ca&gt;</span>
00050 <span class="comment">*</span>
00051 <span class="comment">*  Date:   07/04/04</span>
00052 <span class="comment">*</span>
00053 <span class="comment">*  Desc:</span>
00054 <span class="comment">*         Main function, allocates memory and makes calls to the libSPF </span>
00055 <span class="comment">*  library which parses the "fake" query.</span>
00056 <span class="comment">*</span>
00057 <span class="comment">*/</span>
<a name="l00058"></a><a class="code" href="spfquery_8h.html#a4">00058</a> <span class="keywordtype">int</span> <a class="code" href="spfquery_8h.html#a4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
00059 {
00060   <a class="code" href="spf_8h.html#a35">u_int8_t</a> i         = 0;       <span class="comment">/* utility */</span>
00061   <a class="code" href="spf_8h.html#a35">u_int8_t</a> res       = 0;       <span class="comment">/* libSPF result code */</span>
00062   
00063   <span class="keywordtype">char</span>     *margv    = NULL;    <span class="comment">/* pointer to current argv element */</span>
00064   <span class="keywordtype">char</span>     *ip       = NULL;    <span class="comment">/* ip address to test connecting from */</span>
00065   <span class="keywordtype">char</span>     *address  = NULL;    <span class="comment">/* email address to test sending from */</span>
00066   <span class="keywordtype">char</span>     *helo     = NULL;    <span class="comment">/* helo hostname to test sending from */</span>
00067 
00068   <span class="keywordtype">char</span>     *tmp      = NULL;    <span class="comment">/* utility pointer */</span>
00069   
00070   <a class="code" href="structpeer__info__s.html">peer_info_t</a> *pinfo = NULL;    <span class="comment">/* libSPF peer_info structure */</span>
00071 
00072   <span class="keywordflow">if</span> (argc &lt;= 1)
00073   {
00074     <a class="code" href="spfquery_8c.html#a1">SPF_usage</a>();
00075     <span class="keywordflow">return</span>(<a class="code" href="spf_8h.html#a92a53">FALSE</a>);
00076   }
00077 
00078   <span class="keywordflow">for</span> (i = 1; i &lt; argc; i++)
00079   {
00080     tmp = argv[i];
00081 
00082     <span class="keywordflow">if</span> (*tmp == <span class="charliteral">'-'</span>)
00083     {
00084       margv = (tmp + 3);
00085       
00086       <span class="keywordflow">switch</span> (*(tmp + 1))
00087       {
00088         <span class="keywordflow">case</span> <span class="charliteral">'d'</span> :
00089           <a class="code" href="main_8c.html#a0">confg</a>.<a class="code" href="structspf__config__s.html#o0">level</a> = atoi(margv);
00090           <span class="keywordflow">break</span>;
00091         <span class="keywordflow">case</span> <span class="charliteral">'i'</span> :
00092           ip  = strdup(margv);
00093           <span class="keywordflow">break</span>;
00094         <span class="keywordflow">case</span> <span class="charliteral">'s'</span> :
00095           address = strdup(margv);
00096           <span class="keywordflow">break</span>;
00097         <span class="keywordflow">case</span> <span class="charliteral">'h'</span> :
00098           helo  = strdup(margv);
00099           <span class="keywordflow">break</span>;
00100       }
00101     }
00102   }
00103  
00104   <span class="keywordflow">if</span> (ip == NULL)
00105   {
00106     printf(<span class="stringliteral">"You need to specify an IP Address to test against\n\n"</span>);
00107     <a class="code" href="spfquery_8c.html#a1">SPF_usage</a>();
00108     <span class="keywordflow">return</span>(<a class="code" href="spf_8h.html#a92a53">FALSE</a>);
00109   }
00110   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (address == NULL)
00111   {
00112     printf(<span class="stringliteral">"You need to specify a from email address\n\n"</span>);
00113     <a class="code" href="spfquery_8c.html#a1">SPF_usage</a>();
00114     <span class="keywordflow">return</span>(<a class="code" href="spf_8h.html#a92a53">FALSE</a>);
00115   }
00116   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (helo == NULL)
00117   {
00118     helo = strdup(<a class="code" href="spfquery_8h.html#a2">HELO_HOST</a>);
00119     printf(<span class="stringliteral">"You didn't give me a helo host, using (%s)\n"</span>, helo);
00120     <span class="keywordflow">return</span>(<a class="code" href="spf_8h.html#a92a53">FALSE</a>);
00121   }
00122 
00123   <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#a0">confg</a>.<a class="code" href="structspf__config__s.html#o0">level</a> &gt;= 1)
00124   {
00125     printf(<span class="stringliteral">"SPF Query v%s - James Couzens &lt;jcouzens@codeshare.ca&gt;\n\n"</span>, 
00126       <a class="code" href="spfquery_8h.html#a1">SPFQUERY_VERSION</a>);
00127    
00128     printf(<span class="stringliteral">"DEBUG: %u\n"</span>, <a class="code" href="main_8c.html#a0">confg</a>.<a class="code" href="structspf__config__s.html#o0">level</a>);
00129     printf(<span class="stringliteral">"IP address: %s\n"</span>, ip);
00130     printf(<span class="stringliteral">"MAIL FROM: %s\n"</span>, address);
00131     printf(<span class="stringliteral">"HELO: %s\n"</span>, helo);
00132   }
00133   
00134   <span class="keywordflow">if</span> ((pinfo = <a class="code" href="spf_8h.html#a82">SPF_init</a>(helo, ip, NULL, NULL, NULL, <a class="code" href="spf_8h.html#a92a53">FALSE</a>, <a class="code" href="spf_8h.html#a92a53">FALSE</a>)) != NULL)
00135   {
00136     <span class="comment">/* perform fake HELO */</span>
00137     <a class="code" href="spf_8h.html#a89">SPF_smtp_helo</a>(pinfo, helo);
00138     
00139     <span class="comment">/* perform fake MAIL FROM */</span>
00140     <a class="code" href="spf_8h.html#a88">SPF_smtp_from</a>(pinfo, address);
00141     
00142     <span class="comment">/* perform SPF parse */</span>
00143     pinfo-&gt;<a class="code" href="structpeer__info__s.html#o3">RES</a> = <a class="code" href="spf_8h.html#a84">SPF_policy_main</a>(pinfo);
00144     
00145     <span class="comment">/* assign result of SPF parse */</span>
00146     res = pinfo-&gt;<a class="code" href="structpeer__info__s.html#o3">RES</a>;
00147 
00148     <span class="comment">/* print the results */</span>
00149     printf( <span class="stringliteral">"%s\n%s\n%s\n"</span>,
00150       pinfo-&gt;<a class="code" href="structpeer__info__s.html#o5">rs</a> ? pinfo-&gt;<a class="code" href="structpeer__info__s.html#o5">rs</a> : <span class="stringliteral">"NULL"</span>,
00151       pinfo-&gt;<a class="code" href="structpeer__info__s.html#o26">error</a> ? pinfo-&gt;<a class="code" href="structpeer__info__s.html#o26">error</a> : <span class="stringliteral">"NULL"</span>,
00152       pinfo-&gt;<a class="code" href="structpeer__info__s.html#o12">explain</a> ? pinfo-&gt;<a class="code" href="structpeer__info__s.html#o12">explain</a> : <span class="stringliteral">"NULL"</span>);
00153 
00154     <span class="comment">/* close SPF session (free memory associated with parse) */</span>
00155     <a class="code" href="spf_8h.html#a83">SPF_close</a>(pinfo);
00156 
00157   }   
00158   
00159   free(ip);
00160   free(address);
00161   free(helo);
00162   
00163   <span class="keywordflow">return</span>(<a class="code" href="spf_8h.html#a92a53">FALSE</a>); 
00164 }
00165 
00166 
00167 <span class="comment">/* SPF_usage</span>
00168 <span class="comment">*</span>
00169 <span class="comment">*  Author: James Couzens &lt;jcouzens@6o4.ca&gt;</span>
00170 <span class="comment">*</span>
00171 <span class="comment">*  Date:   12/25/03</span>
00172 <span class="comment">*</span>
00173 <span class="comment">*  Desc:</span>
00174 <span class="comment">*         Displays usage help information when the binary is called with</span>
00175 <span class="comment">*  no arguments.</span>
00176 <span class="comment">*</span>
00177 <span class="comment">*/</span>
<a name="l00178"></a><a class="code" href="spfquery_8h.html#a5">00178</a> <span class="keywordtype">void</span> <a class="code" href="spfquery_8c.html#a1">SPF_usage</a>()
00179 {
00180   printf(<span class="stringliteral">"Usage:\n"</span>);
00181   printf(<span class="stringliteral">"\n"</span>);
00182   printf(<span class="stringliteral">"spfquery [dish]\n"</span>);
00183   printf(<span class="stringliteral">"\n"</span>);
00184   printf(<span class="stringliteral">"-d [x]     - DEBUG where x is a number between 1 and 255\n"</span>);
00185   printf(<span class="stringliteral">"-i [addr]  - IP Address where the fake connection will come from\n"</span>);
00186   printf(<span class="stringliteral">"-s [email] - What email address to test with\n"</span>);
00187   printf(<span class="stringliteral">"-h [host]  - HELO hostname to test with\n"</span>);
00188   printf(<span class="stringliteral">"\n"</span>);
00189   printf(<span class="stringliteral">"spfquery -i 10.0.0.2 -s jcouzens@6o4.ca -h spftools.net\n"</span>);
00190 
00191   <span class="keywordflow">return</span>;
00192 }
00193 
00194 <span class="comment">/* end spfquery.c */</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sun Aug 8 11:36:48 2004 for libspf v1.0 by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
